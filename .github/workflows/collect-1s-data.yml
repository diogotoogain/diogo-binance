name: Collect 1s Real-time Data

on:
  schedule:
    # Run every 6 hours at minute 50 (to stay under 6h limit)
    # 00:50, 06:50, 12:50, 18:50 UTC
    - cron: '50 */6 * * *'
  workflow_dispatch:
    inputs:
      duration:
        description: 'Collection duration in seconds (default: 20700 = 5h45min)'
        required: false
        default: '20700'

jobs:
  collect-data:
    runs-on: ubuntu-latest
    timeout-minutes: 355  # 5h55min timeout

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install websockets pandas pyarrow colorama

      - name: Run data collection
        run: |
          cd $GITHUB_WORKSPACE
          python v2/scripts/collect_realtime.py \
            --symbol BTCUSDT \
            --duration ${{ github.event.inputs.duration || '20700' }} \
            --data-dir v2/data/raw/1s \
            --flush-interval 60

      - name: Commit and push data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add only parquet files from the 1s directory
          git add v2/data/raw/1s/*.parquet || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new data to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ðŸ“Š Auto-collect 1s data - ${TIMESTAMP}"
            git push
            echo "âœ… Data committed and pushed successfully"
          fi

      - name: Install Online Learning dependencies
        run: |
          pip install river

      - name: Run Online Learning update
        run: |
          cd $GITHUB_WORKSPACE
          python v2/scripts/online_learning_update.py \
            --data-dir v2/data/raw/1s \
            --model-dir v2/models/online \
            --results-dir v2/results/online_learning

      - name: Commit Online Learning updates
        run: |
          # Add model and results files
          git add v2/models/online/*.pkl || true
          git add v2/results/online_learning/*.json || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No Online Learning updates to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ðŸ§  Online Learning update - ${TIMESTAMP}"
            git push
            echo "âœ… Online Learning updates committed successfully"
          fi
